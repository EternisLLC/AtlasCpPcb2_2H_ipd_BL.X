#include    <xc.h>
#include    <stdio.h>
#include    <libpic30.h>
#include    <stdbool.h>

//#include    "AlwaysBur.h"
//#include    "UART24_K.h"

#include    "alwaysCP_210728.h"
#include    "FunctionRS485_K.h"

#define _DI()		__asm__ volatile("disi #0x3FFF")
#define _EI()		__asm__ volatile("disi #0")

/* UART1 ÉÓÐÏÌØÚÕÅÔÑ ÄÌÑ USB */
#define SIZE_BUFFER_RXU1 256
#define SIZE_BUFFER_TXU1 256
char TxRunU1;		// ÆÌÁÇ - ÐÒÉÚÎÁË ÐÅÒÅÄÁÞÉ // ôëàã - ïðèçíàê ïåðåäà÷è
static volatile struct {
	int		ri, wi, ct;			/* èíäåêñ ÷òåíèÿ, èíäåêñ çàïèñè, ñ÷¸ò÷èê äàííûõ  
                                 * ÉÎÄÅËÓ ÞÔÅÎÉÑ, ÉÎÄÅËÓ ÚÁÐÉÓÉ, ÓÞÅÔÞÉË ÄÁÎÎÙÈ*/
	unsigned char	buff[SIZE_BUFFER_TXU1];	/* ÂÕÆÅÒ FIFO áóôåð */
} TxFifoU1;
static volatile struct {
	int		ri, wi, ct;			/* èíäåêñ ÷òåíèÿ, èíäåêñ çàïèñè, ñ÷¸ò÷èê äàííûõ 
                                 * ÉÎÄÅËÓ ÞÔÅÎÉÑ, ÉÎÄÅËÓ ÚÁÐÉÓÉ, ÓÞÅÔÞÉË ÄÁÎÎÙÈ*/
	unsigned char	buff[SIZE_BUFFER_RXU1];	/* ÂÕÆÅÒ FIFO áóôåð */
}RxFifoU1;
/*----------- ÏÔÐÒÁ×ËÁ ÏÄÎÏÇÏ ÂÁÊÔÁ × Tx FIFO ÂÕÆÅÒ 
            * Îòïðåâêà îäíîãî áàéòà â Tx FIFO áóôåð 
 * ------------------*/
void uart1_putc (unsigned char d)
{
	int i;
	while (TxFifoU1.ct >= SIZE_BUFFER_TXU1){
//+++++++++++++++
//        if(!_U1TXIF && TxRun){
//            _U1TXIF = 1;
//        }
//++++++++++++++++
    }
	i = TxFifoU1.wi;		
	TxFifoU1.buff[i++] = d; //ÚÁÐÉÓØ × Tx FIFO ÂÕÆÅÒ ÏÄÎÏÇÏ ÂÁÊÔÁ //çàïèñü â Tx FIFO áóôåð îäíîãî áàéòà
	TxFifoU1.wi = i % SIZE_BUFFER_TXU1;
	_DI();
	TxFifoU1.ct++;
	if (!_U1TXIF) {		//ÅÓÌÉ ÐÅÒÅÄÁÞÁ ÐÏ UART Tx ÎÅ ×ÅÄ£ÔÓÑ, ÔÏ .. //åñëè ïåðåäà÷à ïî UART Tx íå âåä¸òñÿ, òî ..
		TxRunU1 = 1;    //ÕÓÔÁÎÏ×ËÁ ÆÌÁÇÁ - ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ //óñòàíîâêà ôëàãà - ïðèçíàêà ïåðåäà÷è
		_U1TXIF = 1;	//ÒÁÚÒÅÛÅÎÉÑ ÐÒÅÒÙ×ÁÎÉÑ ÏÔ UART Tx //ðàçðåøåíèÿ ïðåðûâàíèÿ îò UART Tx
	}
	_EI();
}

//----------- Èíèöèàëèçàöèÿ UART1 ------------------
//----------- éÎÉÃÉÁÌÉÚÁÃÉÑ UART1 ------------------
void InitUart1 (unsigned long bps)
{
	//âûêëþ÷åíèå UART è Tx/Rx ïðåðûâàíèé
    //×ÙËÌÀÞÅÎÉÅ UART É Tx/Rx ÐÒÅÒÙ×ÁÎÉÊ
    U1MODEbits.UARTEN = 0;
	U1STAbits.UTXEN = 0;
	_U1RXIE = 0;
	_U1TXIE = 0;
    _U1TXIF = 0;
    _U1RXIF = 0;
    _U1TXIP = 4;
    _U1RXIP = 4;
    
	//èíèöèàëèçàöèÿ UART1 
    //ÉÎÉÃÉÁÌÉÚÁÃÉÑ UART1 
	U1BRG = FCY / 4 / bps - 1;
    U1MODEbits.BRGH = 1;
//    _RP29R =_RPOUT_U1TX;        //ÐÏÄËÌÀÞÅÎÉÅ ÍÏÄÕÌÑ TX1 Ë ÎÏÖËÅ RP29//ïîäêëþ÷åíèå ìîäóëÿ TX1 ê íîæêå RP29
//    _U1RXR = 14;                //ÐÏÄËÌÀÞÅÎÉÅ ÍÏÄÕÌÑ RX1 Ë ÎÏÖËÅ PR14//ïîäêëþ÷åíèå ìîäóëÿ RX1 ê íîæêå PR14
    RPOR15bits.RP30R = 0x0003;    //RF2->UART1:U1TX
    RPINR18bits.U1RXR = 0x002D;    //RF6->UART1:U1RX
	//î÷èñòêà ñ÷¸ò÷èêîâ è óêàçàòåëåé Tx/Rx FIFO áóôåðîâ
    //ÏÞÉÓÔËÁ ÓÞ£ÔÞÉËÏ× É ÕËÁÚÁÔÅÌÅÊ Tx/Rx FIFO ÂÕÆÅÒÏ×
	TxFifoU1.ri = 0; TxFifoU1.wi = 0; TxFifoU1.ct = 0;
	RxFifoU1.ri = 0; RxFifoU1.wi = 0; RxFifoU1.ct = 0;
	TxRunU1 = 0;
    U1MODEbits.UARTEN = 1;
	U1STAbits.UTXEN = 1;
    
    _U1RXIE = 1;
    _U1TXIE = 1;
}
//----------- ISR ïðåðûâàíèå îò UART1 Rx ------------------
//----------- ISR ÐÒÅÒÙ×ÁÎÉÅ ÏÔ UART1 Rx ------------------
void __attribute__((interrupt, auto_psv)) _U1RXInterrupt (void)
{
	unsigned char d;
	int i;
	d = (unsigned char)U1RXREG;     //ÐÏÌÕÞÅÎÉÅ ÂÁÊÔÁ ÄÁÎÎÙÈ //ïîëó÷åíèå áàéòà äàííûõ
//+++++++
    if(d=='1'){
        CommandDebug = 1;
    }else{
        if(d >= '0' && d <='9')CommandDebug = 0;
    }
//+++++++    
	_U1RXIF = 0;                    //ÏÞÉÓÔËÁ ÆÌÁÇÁ ÐÒÅÒÙ×ÁÎÉÑ RX//î÷èñòêà ôëàãà ïðåðûâàíèÿ RX
	i = RxFifoU1.ct;				//ËÏÌÉÞÅÓÔ×Ï ÂÁÊÔ × RX FIFO ÂÕÆÅÒÅ//êîëè÷åñòâî áàéò â RX FIFO áóôåðå
	if (i < SIZE_BUFFER_RXU1) {		//ÅÓÌÉ ÂÕÆÅÒ ÎÅ ÐÏÌÎÙÊ, ÔÏ.. //åñëè áóôåð íå ïîëíûé, òî.. 
		RxFifoU1.ct = ++i;          //Õ×ÅÌÉÞÉ×ÁÅÍ ÚÎÁÞÅÎÉÅ ÓÞ£ÔÞÉËÁ ÂÁÊÔ × RX FIFO//óâåëè÷èâàåì çíà÷åíèå ñ÷¸ò÷èêà áàéò â RX FIFO
		i = RxFifoU1.wi;
		RxFifoU1.buff[i++] = d;     //ÚÁÐÉÓÙ×ÁÅÍ ÐÒÉÎÑÔÙÊ ÂÁÊÔ × RX FIFO //çàïèñûâàåì ïðèíÿòûé áàéò â RX FIFO 
		RxFifoU1.wi = i % SIZE_BUFFER_RXU1;	/* Next write ptr */
	}
}
void __attribute__((interrupt, auto_psv)) _U1TXInterrupt (void)
{
    UINT8 tempU1;
	_U1TXIF = 0;            //ÏÞÉÓÔËÁ ÆÌÁÇÁ ÐÒÅÒÙ×ÁÎÉÑ TX//î÷èñòêà ôëàãà ïðåðûâàíèÿ TX
	if (TxFifoU1.ct) {      //ÅÓÌÉ ÅÓÔØ ÄÁÎÎÙÅ × TX FIFO ÂÕÆÅÒÅ//åñëè åñòü äàííûå â TX FIFO áóôåðå
		TxFifoU1.ct --;
        tempU1 = TxFifoU1.buff[TxFifoU1.ri];
        U1TXREG = TxFifoU1.buff[TxFifoU1.ri++];		//ÐÅÒÅÄÁ£Í ÏÄÉÎ ÂÁÊÔ //ïåðåäà¸ì îäèí áàéò
        
		TxFifoU1.ri = TxFifoU1.ri % SIZE_BUFFER_TXU1;	// Next read ptr
	} else {                //ÅÓÌÉ ÎÅÔ ÄÁÎÎÙÈ × Tx FIFO ÂÕÆÅÒÅ, ÔÏ ..//åñëè íåò äàííûõ â Tx FIFO áóôåðå, òî ..
        while(!U1STAbits.TRMT);
		TxRunU1 = 0;		//ÓÂÒÁÓÙ×ÁÅÍ ÆÌÁÇ ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ//ñáðàñûâàåì ôëàã ïðèçíàêà ïåðåäà÷è
	}
}

//----------- Ïðîâåðêà êîëè÷åñòâà áàéò â Rx FIFO áóôåðå  ------------------
//----------- ðÒÏ×ÅÒËÁ ËÏÌÉÞÅÓÔ×Á ÂÁÊÔ × Rx FIFO ÂÕÆÅÒÅ  ------------------
int uart1_testRx (void)
{
	return RxFifoU1.ct;	//âîçâðàùàåì êîëè÷åñòâî áàéò â Rx FIFO áóôåðå
                        //×ÏÚ×ÒÁÝÁÅÍ ËÏÌÉÞÅÓÔ×Ï ÂÁÊÔ × Rx FIFO ÂÕÆÅÒÅ
}
int uart1_testTx (void)
{
	return TxFifoU1.ct;	//âîçâðàùàåì êîëè÷åñòâî áàéò â Tx FIFO áóôåðå
                        //×ÏÚ×ÒÁÝÁÅÍ ËÏÌÉÞÅÓÔ×Ï ÂÁÊÔ × Tx FIFO ÂÕÆÅÒÅ
}


/*----------- Ïîëó÷åíèå îäíîãî áàéòà èç Rx FIFO áóôåðà */
/*----------- ðÏÌÕÞÅÎÉÅ ÏÄÎÏÇÏ ÂÁÊÔÁ ÉÚ Rx FIFO ÂÕÆÅÒÁ */
unsigned char uart1_getc (void)
{
	unsigned char d;
	int i;
	while (!RxFifoU1.ct);   //ÏÖÉÄÁÎÉÅ ÐÏÑ×ÌÅÎÉÑ ÄÁÎÎÙÈ × Rx FIFO ÂÕÆÅÒÅ//îæèäàíèå ïîÿâëåíèÿ äàííûõ â Rx FIFO áóôåðå
	i = RxFifoU1.ri;				
	d = RxFifoU1.buff[i++]; //ÞÔÅÎÉÅ ÂÁÊÔÁ ÉÚ Rx FIFO ,ÂÕÆÅÒÁ//÷òåíèå áàéòà èç Rx FIFO ,áóôåðà
	RxFifoU1.ri = i % SIZE_BUFFER_RXU1;
	_DI();
	RxFifoU1.ct--;
	_EI();
	return d;
}

// ÐÀÁÎÒÀ UART ÄËß RS485
// òáâïôá UART äìñ RS485
unsigned char TxRunRs;		// ÆÌÁÇ - ÐÒÉÚÎÁË ÐÅÒÅÄÁÞÉ// ôëàã - ïðèçíàê ïåðåäà÷è 

sructTxRsFifo   TxFifoRs; 
sructRxRsFifo   RxFifoRs;
/* ÆÕÎËÃÉÉ ÐÏÄÓÞÅÔÁ CRC ôóíêöèè ïîäñ÷åòà CRC */
const unsigned char Crc8Table[256] = {
    0x00, 0x31, 0x62, 0x53, 0xC4, 0xF5, 0xA6, 0x97,
    0xB9, 0x88, 0xDB, 0xEA, 0x7D, 0x4C, 0x1F, 0x2E,
    0x43, 0x72, 0x21, 0x10, 0x87, 0xB6, 0xE5, 0xD4,
    0xFA, 0xCB, 0x98, 0xA9, 0x3E, 0x0F, 0x5C, 0x6D,
    0x86, 0xB7, 0xE4, 0xD5, 0x42, 0x73, 0x20, 0x11,
    0x3F, 0x0E, 0x5D, 0x6C, 0xFB, 0xCA, 0x99, 0xA8,
    0xC5, 0xF4, 0xA7, 0x96, 0x01, 0x30, 0x63, 0x52,
    0x7C, 0x4D, 0x1E, 0x2F, 0xB8, 0x89, 0xDA, 0xEB,
    0x3D, 0x0C, 0x5F, 0x6E, 0xF9, 0xC8, 0x9B, 0xAA,
    0x84, 0xB5, 0xE6, 0xD7, 0x40, 0x71, 0x22, 0x13,
    0x7E, 0x4F, 0x1C, 0x2D, 0xBA, 0x8B, 0xD8, 0xE9,
    0xC7, 0xF6, 0xA5, 0x94, 0x03, 0x32, 0x61, 0x50,
    0xBB, 0x8A, 0xD9, 0xE8, 0x7F, 0x4E, 0x1D, 0x2C,
    0x02, 0x33, 0x60, 0x51, 0xC6, 0xF7, 0xA4, 0x95,
    0xF8, 0xC9, 0x9A, 0xAB, 0x3C, 0x0D, 0x5E, 0x6F,
    0x41, 0x70, 0x23, 0x12, 0x85, 0xB4, 0xE7, 0xD6,
    0x7A, 0x4B, 0x18, 0x29, 0xBE, 0x8F, 0xDC, 0xED,
    0xC3, 0xF2, 0xA1, 0x90, 0x07, 0x36, 0x65, 0x54,
    0x39, 0x08, 0x5B, 0x6A, 0xFD, 0xCC, 0x9F, 0xAE,
    0x80, 0xB1, 0xE2, 0xD3, 0x44, 0x75, 0x26, 0x17,
    0xFC, 0xCD, 0x9E, 0xAF, 0x38, 0x09, 0x5A, 0x6B,
    0x45, 0x74, 0x27, 0x16, 0x81, 0xB0, 0xE3, 0xD2,
    0xBF, 0x8E, 0xDD, 0xEC, 0x7B, 0x4A, 0x19, 0x28,
    0x06, 0x37, 0x64, 0x55, 0xC2, 0xF3, 0xA0, 0x91,
    0x47, 0x76, 0x25, 0x14, 0x83, 0xB2, 0xE1, 0xD0,
    0xFE, 0xCF, 0x9C, 0xAD, 0x3A, 0x0B, 0x58, 0x69,
    0x04, 0x35, 0x66, 0x57, 0xC0, 0xF1, 0xA2, 0x93,
    0xBD, 0x8C, 0xDF, 0xEE, 0x79, 0x48, 0x1B, 0x2A,
    0xC1, 0xF0, 0xA3, 0x92, 0x05, 0x34, 0x67, 0x56,
    0x78, 0x49, 0x1A, 0x2B, 0xBC, 0x8D, 0xDE, 0xEF,
    0x82, 0xB3, 0xE0, 0xD1, 0x46, 0x77, 0x24, 0x15,
    0x3B, 0x0A, 0x59, 0x68, 0xFF, 0xCE, 0x9D, 0xAC
};


unsigned char Crc8(unsigned char *pcBlock, unsigned char len)
{
    unsigned char crc = 0x00;
 
    while (len--)
        crc = Crc8Table[crc ^ *(pcBlock++)];       
    return crc;
}
unsigned char crc_value = 0;
/*++++++ÏÞÉÓÔËÁ ÂÕÆÅÒÁ RxFifoRs ++++++î÷èñòêà áóôåðà RxFifoRs*/
void ClrFifo(void){
    unsigned int jj;
    unsigned char *pct;
    unsigned char *pcr;
    pct = (unsigned char*)&TxFifoRs.buffRsTx[0];
    pcr = (unsigned char*)&RxFifoRs.buffRsRx[0];
    for(jj = 0; jj < SIZE_BUFFER_RXRS; jj++){
        *pcr = 0;
        pcr++;
    }
    for(jj = 0; jj < SIZE_BUFFER_TXRS; jj++){
        *pct = 0;
        pct++;
    }
    TxFifoRs.riRsTx = 0; TxFifoRs.wiRsTx = 0; TxFifoRs.ctRsTx = 0;
	RxFifoRs.riRsRx = 0; RxFifoRs.wiRsRx = 0; RxFifoRs.ctRsRx = 0;
	TxRunRs = 0;
}
//----------- Èíèöèàëèçàöèÿ UART3 ìîäóëÿ ------------------
//----------- éÎÉÃÉÁÌÉÚÁÃÉÑ UART3 ÍÏÄÕÌÑ ------------------
void InitRS485 (unsigned long bps)
{
	// èíèöèàëèçàöèÿ íîæêè óïðàâëåíèÿ ïåðåäà÷åé RS485
    // ÉÎÉÃÉÁÌÉÚÁÃÉÑ ÎÏÖËÉ ÕÐÒÁ×ÌÅÎÉÑ ÐÅÒÅÄÁÞÅÊ RS485
    ENTX485 = 0;
    TRIS_ENTX485 = 0;
    _TRISB14 = 0;
    //âûêëþ÷åíèå UART Tx/Rx ïðåðûâàíèé
    //×ÙËÌÀÞÅÎÉÅ UART Tx/Rx ÐÒÅÒÙ×ÁÎÉÊ
    _U3RXIE = 0;
	_U3TXIE = 0;
    _U3TXIF = 0;
    _U3RXIF = 0;
    _U3TXIP = 4;
    _U3RXIP = 4;
    _U3ERIP = 4;
    
//	_U3RXIE = 0;
//	_U3TXIE = 0;
    U3MODEbits.UARTEN = 0;
	U3STAbits.UTXEN = 0;
//    _RP10R = 0;       //ÏÔËÌÀÞÅÎÉÅ ÎÏÖËÉ RP10 ÏÔ ÍÏÄÕÌÑ TX3 //îòêëþ÷åíèå íîæêè RP10 îò ìîäóëÿ TX3  
//    _U3RXR = 0x3F;    //ÏÔËÌÀÞÅÎÉÅ ÍÏÄÕÌÑ RX3 ÏÔ ÎÏÖËÉ PR17//îòêëþ÷åíèå ìîäóëÿ RX3 îò íîæêè PR17
	//èíèöèàëèçàöèÿ UART1 
	U3BRG = FCY / 4 / bps - 1;
//    _RP10R =_RPOUT_U3TX;        //ÐÏÄËÌÀÞÅÎÉÅ ÍÏÄÕÌÑ TX3 Ë ÎÏÖËÅ RP10//ïîäêëþ÷åíèå ìîäóëÿ TX3 ê íîæêå RP10
//    _U3RXR = 17;                //ÐÏÄËÌÀÞÅÎÉÅ ÍÏÄÕÌÑ RX3 Ë ÎÏÖËÅ PR17//ïîäêëþ÷åíèå ìîäóëÿ RX3 ê íîæêå PR17
//ZZZZZZZZZZZZZZZZZZZZZZZZ 15.06.22 ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
//    RPINR17bits.U3RXR = 0x001D;    //RB15->UART3:U3RX
//    RPOR7bits.RP14R = 0x001C;    //RB14->UART3:U3TX
//    RPOR13bits.RP26R = 0x001C;    //RG7->UART3:U3TX
    
//ZZZZZZZZZZZZZZZZZZZZZZZZ 15.06.22 ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
//    _RP16R =  _RPOUT_U3TX;    // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A //RF3->UART3:U3TX 
    _RP16R = 0; // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A
    _RP14R =  _RPOUT_U3TX;    //RB14->UART3:U3TX
    _U3RXR = 29;    //RB15->UART3:U3RX
     //ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
    
    //î÷èñòêà ñ÷¸ò÷èêîâ è óêàçàòåëåé Tx/Rx FIFO áóôåðîâ
    //ÏÞÉÓÔËÁ ÓÞ£ÔÞÉËÏ× É ÕËÁÚÁÔÅÌÅÊ Tx/Rx FIFO ÂÕÆÅÒÏ×
    ClrFifo();
    U3MODEbits.BRGH = 1;
	U3MODEbits.UARTEN = 1;
	U3STAbits.UTXEN = 0;
    U3STAbits.UTXISEL0=0;       //ÒÅÖÉÍ ÐÒÅÒÙ×ÁÎÉÑ TX 1-×Ó£ ÐÅÒÅÄÁÎÏ//ðåæèì ïðåðûâàíèÿ TX 1-âñ¸ ïåðåäàíî
    U3STAbits.UTXISEL1=0;       //ÒÅÖÉÍ ÐÒÅÒÙ×ÁÎÉÑ TX 1-U3TXREG ÐÕÓÔ//ðåæèì ïðåðûâàíèÿ TX 1-U3TXREG ïóñò
	//×ËÌÀÞÅÎÉÅ UART Tx/Rx ÐÒÅÒÙ×ÁÎÉÊ//âêëþ÷åíèå UART Tx/Rx ïðåðûâàíèé
	_U3RXIE = 1;
	_U3TXIE = 1;
    
    _U3ERIF = 0;//-------------------29.11.21------------------------------
    _U3ERIE = 1;//-------------------29.11.21------------------------------
}

//----------- Èíèöèàëèçàöèÿ UART2 ìîäóëÿ ------29.11.21----------------------
//----------- éÎÉÃÉÁÌÉÚÁÃÉÑ UART2 ÍÏÄÕÌÑ ------29.11.21----------------------
void InitRS485_I (unsigned long bps)
{
// èíèöèàëèçàöèÿ íîæêè óïðàâëåíèÿ ïåðåäà÷åé RS485_I
// ÉÎÉÃÉÁÌÉÚÁÃÉÑ ÎÏÖËÉ ÕÐÒÁ×ÌÅÎÉÑ ÐÅÒÅÄÁÞÅÊ RS485
    ENTX485_I = 1;
    //TRIS_ENTX485_I = 0;   // ÉÚÍÅÎÅÎÉÑ ÄÌÑ pcb 2.2 É TD331S485H-A
    _TRISG7 = 0;
    //âûêëþ÷åíèå UART Tx/Rx ïðåðûâàíèé
    //×ÙËÌÀÞÅÎÉÅ UART Tx/Rx ÐÒÅÒÙ×ÁÎÉÊ
    _U2RXIE = 0;
	_U2TXIE = 0;
    _U2TXIF = 0;
    _U2RXIF = 0;
    _U2TXIP = 4;
    _U2RXIP = 4;
    _U2ERIP = 4;
    
//	_U2RXIE = 0;
//	_U2TXIE = 0;
    U2MODEbits.UARTEN = 0;
	U2STAbits.UTXEN = 0;

//	//èíèöèàëèçàöèÿ UART2 
    //ÉÎÉÃÉÁÌÉÚÁÃÉÑ UART2 
	U2BRG = FCY / 4 / bps - 1;
//ZZZZZZZZZZZZZZZZZZZZZZZZ 15.06.22 ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
//    RPINR19bits.U2RXR = 0x0015;    //RG6->UART2:U2RX
//ZZZZZZZZZZZZZZZZZZZZZZZZ 15.06.22 ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
//    RPINR19bits.U2RXR = 0x0011;    //RF5->UART2:U2RX
    _U2RXR = 17;
//ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
    
    //î÷èñòêà ñ÷¸ò÷èêîâ è óêàçàòåëåé Tx/Rx FIFO áóôåðîâ
    //ÏÞÉÓÔËÁ ÓÞ£ÔÞÉËÏ× É ÕËÁÚÁÔÅÌÅÊ Tx/Rx FIFO ÂÕÆÅÒÏ×
    ClrFifo();
    U2MODEbits.BRGH = 1;
	U2MODEbits.UARTEN = 1;
	U2STAbits.UTXEN = 0;//U2STAbits.UTXEN = 1;

	//âêëþ÷åíèå UART Tx/Rx ïðåðûâàíèé
    //×ËÌÀÞÅÎÉÅ UART Tx/Rx ÐÒÅÒÙ×ÁÎÉÊ
	_U2RXIE = 1;
	_U2TXIE = 0;//_U2TXIE = 1;
    
    _U2ERIF = 0;//-------------------29.11.21------------------------------
    _U2ERIE = 1;//-------------------29.11.21------------------------------
}

//----------- Ïðîâåðêà êîëè÷åñòâà áàéò â Rx FIFO áóôåðå  ------------------
//----------- ðÒÏ×ÅÒËÁ ËÏÌÉÞÅÓÔ×Á ÂÁÊÔ × Rx FIFO ÂÕÆÅÒÅ  ------------------
int RS485_testRx (void)
{
	return RxFifoRs.ctRsRx;	//âîçâðàùàåì êîëè÷åñòâî áàéò â Rx FIFO áóôåðå
                            //×ÏÚ×ÒÁÝÁÅÍ ËÏÌÉÞÅÓÔ×Ï ÂÁÊÔ × Rx FIFO ÂÕÆÅÒÅ
}
int RS485_testTx (void)
{
	return TxFifoRs.ctRsTx;	//âîçâðàùàåì êîëè÷åñòâî áàéò â Tx FIFO áóôåðå
}                           //×ÏÚ×ÒÁÝÁÅÍ ËÏÌÉÞÅÓÔ×Ï ÂÁÊÔ × Tx FIFO ÂÕÆÅÒÅ

/*----------- Ïîëó÷åíèå îäíîãî áàéòà èç Rx FIFO áóôåðà 
* ----------- ðÏÌÕÞÅÎÉÅ ÏÄÎÏÇÏ ÂÁÊÔÁ ÉÚ Rx FIFO ÂÕÆÅÒÁ */
unsigned char RS485_getc (void)
{
	unsigned char d;
	while (!RxFifoRs.ctRsRx); //ÏÖÉÄÁÎÉÅ ÐÏÑ×ÌÅÎÉÑ ÄÁÎÎÙÈ × Rx FIFO ÂÕÆÅÒÅ//îæèäàíèå ïîÿâëåíèÿ äàííûõ â Rx FIFO áóôåðå
	d = RxFifoRs.buffRsRx[RxFifoRs.riRsRx ++];//ÞÔÅÎÉÅ ÂÁÊÔÁ ÉÚ Rx FIFO ,ÂÕÆÅÒÁ//÷òåíèå áàéòà èç Rx FIFO ,áóôåðà
	RxFifoRs.riRsRx = RxFifoRs.riRsRx % SIZE_BUFFER_RXRS;
	_DI();
	RxFifoRs.ctRsRx --;
	_EI();
	return d;
}

//----------- Îòïðaâêà îäíîãî áàéòà â Tx FIFO áóôåð ------------------
//----------- ïÔÐÒa×ËÁ ÏÄÎÏÇÏ ÂÁÊÔÁ × Tx FIFO ÂÕÆÅÒ ------------------
//void RS485_putc (unsigned char d)
//{
//	int i;
//	unsigned char delay;
//    while (TxFifoRs.ctRsTx >= SIZE_BUFFER_TXRS){
//     Nop();	//ÖÄ£Í, ÅÓÌÉ Tx FIFO ÂÕÆÅÒ//æä¸ì, åñëè Tx FIFO áóôåð
//    }
//	i = TxFifoRs.wiRsTx;		
//	TxFifoRs.buffRsTx[i++] = d; //ÚÁÐÉÓØ × Tx FIFO ÂÕÆÅÒ ÏÄÎÏÇÏ ÂÁÊÔÁ//çàïèñü â Tx FIFO áóôåð îäíîãî áàéòà
//    if(d != '\r' && d != '\n' && d != 0){
//        crc_value = Crc8Table[crc_value ^ d];
//    }else{
//        crc_value = 0;
//    }
//	TxFifoRs.wiRsTx = i % SIZE_BUFFER_TXRS;
//	_DI();
//	TxFifoRs.ctRsTx++;
//	if (!TxRunRs) {//ÅÓÌÉ ÐÅÒÅÄÁÞÁ ÐÏ UART Tx ÎÅ ×ÅÄ£ÔÓÑ, ÔÏ ..//åñëè ïåðåäà÷à ïî UART Tx íå âåä¸òñÿ, òî ..
//		TxRunRs = 1; //ÕÓÔÁÎÏ×ËÁ ÆÌÁÇÁ - ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ//óñòàíîâêà ôëàãà - ïðèçíàêà ïåðåäà÷è
//        //-------------------------------------29.11.21------------------------------        
//        //------Âêëþ÷åíèå ïåðåäà÷è ïî íàïðàâëåíèÿì RS485------------------------
//        //------÷ËÌÀÞÅÎÉÅ ÐÅÒÅÄÁÞÉ ÐÏ ÎÁÐÒÁ×ÌÅÎÉÑÍ RS485------------------------
//        U3STAbits.UTXEN = 1;
//        if(DirRS485.UART_TX3)
//            ENTX485 = 1;
//        if(DirRS485.UART_TX2)
//            _RP16R = _RPOUT_U3TX;    // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A
//            ENTX485_I = 0;  // TXD RS485_I ÐÒÏÇÒÁÍÍÎÏ ÐÏÄËÌÀÞÅÎ Ë ×ÙÈÏÄÕ TXD RS485
//                            // TXD RS485_I ïðîãðàììíî ïîäêëþ÷åí ê âûõîäó TXD RS485
////-------------------------------------29.11.21------------------------------  
//        for(delay = 0; delay < 60; delay ++);//vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
////        ENTX485 = 1;
//		_U3TXIE = 1;	//ÒÁÚÒÅÛÅÎÉÑ ÐÒÅÒÙ×ÁÎÉÑ ÏÔ UART3 Tx//ðàçðåøåíèÿ ïðåðûâàíèÿ îò UART3 Tx
////        _U3TXIF = 1;
//	}
//	_EI();
//}

#define xdev_out(func) xfunc_out = (void(*)(unsigned char))(func)
//extern void (*xfunc_out)(unsigned char);
#define xdev_in(func) xfunc_in = (unsigned char(*)(void))(func)
//extern unsigned char (*xfunc_in)(void);
static char *outptr;
unsigned char (*xfunc_in)(void);	/* Pointer to the input stream */
void (*xfunc_out)(unsigned char);	/* Pointer to the output stream */


void xputc (char c)
{
	if (_CR_CRLF && c == '\n')  xputc('\r');		/* CR -> CRLF */
	if (outptr) {
		*outptr++ = (unsigned char)c;
    	return;
	}
	if (xfunc_out) xfunc_out((unsigned char)c);
}
/*----------------------------------------------*/
/* Put a null-terminated string                 */
/*----------------------------------------------*/
void xputs (					// Put a string to the default device
	const char* str				// Pointer to the string
)
{
	while (*str)
		xputc(*str++);
}
#include    <stdarg.h>
static void xvprintf (
	const char*	fmt,	/* Pointer to the format string */
	va_list arp			/* Pointer to arguments */
)
{
	unsigned int r, i, j, w, f;
	unsigned long v;
	char s[16], c, d, *p;


	for (;;) {
		c = *fmt++;					/* Get a char */
		if (!c) break;				/* End of format? */
		if (c != '%') {				/* Pass through it if not a % sequense */
			xputc(c); continue;
		}
		f = 0;
		c = *fmt++;					/* Get first char of the sequense */
		if (c == '0') {				/* Flag: '0' padded */
			f = 1; c = *fmt++;
		} else {
			if (c == '-') {			/* Flag: left justified */
				f = 2; c = *fmt++;
			}
		}
		for (w = 0; c >= '0' && c <= '9'; c = *fmt++)	/* Minimum width */
			w = w * 10 + c - '0';
		if (c == 'l' || c == 'L') {	/* Prefix: Size is long int */
			f |= 4; c = *fmt++;
		}
		if (!c) break;				/* End of format? */
		d = c;
		if (d >= 'a') d -= 0x20;
		switch (d) {				/* Type is... */
		case 'S' :					/* String */
			p = va_arg(arp, char*);
			for (j = 0; p[j]; j++) ;
			while (!(f & 2) && j++ < w) xputc(' ');
			xputs(p);
			while (j++ < w) xputc(' ');
			continue;
		case 'C' :					/* Character */
			xputc((char)va_arg(arp, int)); continue;
		case 'B' :					/* Binary */
			r = 2; break;
		case 'O' :					/* Octal */
			r = 8; break;
		case 'D' :					/* Signed decimal */
		case 'U' :					/* Unsigned decimal */
			r = 10; break;
		case 'X' :					/* Hexdecimal */
			r = 16; break;
		default:					/* Unknown type (passthrough) */
			xputc(c); continue;
		}

		/* Get an argument and put it in numeral */
		v = (f & 4) ? va_arg(arp, long) : ((d == 'D') ? (long)va_arg(arp, int) : (long)va_arg(arp, unsigned int));
		if (d == 'D' && (v & 0x80000000)) {
			v = 0 - v;
			f |= 8;
		}
		i = 0;
		do {
			d = (char)(v % r); v /= r;
			if (d > 9) d += (c == 'x') ? 0x27 : 0x07;
			s[i++] = d + '0';
		} while (v && i < sizeof(s));
		if (f & 8) s[i++] = '-';
		j = i; d = (f & 1) ? '0' : ' ';
		while (!(f & 2) && j++ < w) xputc(d);
		do xputc(s[--i]); while(i);
		while (j++ < w) xputc(' ');
	}
}

void xprintf (			/* Put a formatted string to the default device */
	const char*	fmt,	/* Pointer to the format string */
	...					/* Optional arguments */
)
{
	va_list arp;
	va_start(arp, fmt);
	xvprintf(fmt, arp);
	va_end(arp);
}

DirRS DirRS485;     //-----------------------------29.11.21---------------------

ErrorRS ErrorDirRS485;     //-----------------------------29.11.21---------------------

void InitUSBTerminal (unsigned long bps){
    InitUart1 (bps);
//	xdev_in(RS485_getc);		//ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âõîäíîãî ïîòîêà
//	xdev_out(RS485_putc);       //ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÙÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âûõîäíîãî ïîòîêà
    xdev_in(uart1_getc);		//ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âõîäíîãî ïîòîêà
	xdev_out(uart1_putc);       //ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÙÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âûõîäíîãî ïîòîêà
}
// ÉÚÍ. 05.04.22
//unsigned char CurrentModeRs;
static volatile UINT16 CounterRsBreak;
void SelectModeRs485(unsigned char modeRs){
    if(ControlFlagCP.CurrentModeRs != modeRs){
        switch(modeRs){
            case 0: // ÷ÙËÌÀÞÅÎÙ ×ÓÅ ËÁÎÁÌÙ RS
                CLOSE_RX2_UART();
                CLOSE_UART_TX2();
                CLOSE_RX3_UART();
                CLOSE_UART_TX3();
                CLOSE_RX3_TX2();
                CLOSE_RX2_TX3();
                break;
            case 1: // ÒÅÖÉÍ ÌÉÎÅÊÎÏÊ ÐÅÒÅÄÁÞÉ RS
                NumberOfResponses[1] = 0;
                OPEN_RX2_UART();
                OPEN_RX3_UART();
                OPEN_UART_TX2();
                OPEN_UART_TX3();
                OPEN_RX3_TX2();
                OPEN_RX2_TX3();
                break;
            case 2:// ÐÒÅÒÅÄÁÞÁ É ÐÒÉÅÍ ÞÅÒÅÚ uart2
                if((NumberOfResponses[3] != NumberOfResponses[0])|| (NumberOfResponses[2] != NumberOfResponses[0])){
                    if(CounterRsBreak < MaxNumberRequests){
                        CounterRsBreak ++;
                    }else{
                        ControlFlagCP.RsBreakNew = 1;
                    }
                }else{
                    CounterRsBreak = 0;
                    ControlFlagCP.RsBreakNew = 0;
                }
                CLOSE_RX3_TX2();
                CLOSE_RX2_TX3();    
                CLOSE_RX3_UART();
                CLOSE_UART_TX3();
                OPEN_RX2_UART();
                OPEN_UART_TX2();
                NumberOfResponses[2] = 0;
                break;
            case 3:// ÐÒÅÒÅÄÁÞÁ É ÐÒÉÅÍ ÞÅÒÅÚ uart3
                if((NumberOfResponses[2] != NumberOfResponses[0])|| (NumberOfResponses[3] != NumberOfResponses[0])){
                    if(CounterRsBreak < MaxNumberRequests){
                        CounterRsBreak ++;
                    }else{
                        ControlFlagCP.RsBreakNew = 1;
                    }
                }else{
                    ControlFlagCP.RsBreakNew = 0;
                }
                CLOSE_RX3_TX2();
                CLOSE_RX2_TX3();    
                CLOSE_RX2_UART();
                CLOSE_UART_TX2();
                OPEN_RX3_UART();
                OPEN_UART_TX3();
                NumberOfResponses[3] = 0;
                break;
            default:
                break;
        }
        ControlFlagCP.CurrentModeRs = modeRs;
    }
}

void InitRS485Terminal (unsigned long bps){
    InitRS485(bps);
    InitRS485_I(bps);//----------------------------29.11.21---------------------
    DirRS485.DirRS = 0b00111111;//×ËÌÀÞÅÎÙ ×ÓÅ ÎÁÐÒÁ×ÌÅÎÉÑ RS485--------29.11.21---------
                                //âêëþ÷åíû âñå íàïðàâëåíèÿ RS485--------29.11.21---------
//    CLOSE_RX2_UART();//ôÅÓÔ ÏÔËÌÀÞÅÎÉÑ ÎÁÐÒÁ×ÌÅÎÉÑ//Òåñò îòêëþ÷åíèÿ íàïðàâëåíèÿ--------29.11.21---------
//    CLOSE_RX3_UART();//ôÅÓÔ ÏÔËÌÀÞÅÎÉÑ ÎÁÐÒÁ×ÌÅÎÉÑ//Òåñò îòêëþ÷åíèÿ íàïðàâëåíèÿ--------29.11.21---------
//    CLOSE_UART_TX2();//ôÅÓÔ ÏÔËÌÀÞÅÎÉÑ ÎÁÐÒÁ×ÌÅÎÉÑ//Òåñò îòêëþ÷åíèÿ íàïðàâëåíèÿ--------29.11.21---------
//    CLOSE_UART_TX3();//ôÅÓÔ ÏÔËÌÀÞÅÎÉÑ ÎÁÐÒÁ×ÌÅÎÉÑ//Òåñò îòêëþ÷åíèÿ íàïðàâëåíèÿ--------29.11.21---------
//    CLOSE_RX3_TX2();
//    CLOSE_RX2_TX3();
    SelectModeRs485(ModeRs);    // 03.10.22
//    xdev_in(RS485_getc);		//ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âõîäíîãî ïîòîêà
//	xdev_out(RS485_putc);       //ÉÎÉÃÉÁÌÉÚÁÃÉÑ ×ÙÈÏÄÎÏÇÏ ÐÏÔÏËÁ//èíèöèàëèçàöèÿ âûõîäíîãî ïîòîêà
}
UINT8 CounterErrorRs485;

unsigned char RsTxBuffer[SIZE_BUFFER_TXRS];
unsigned char RsTxCrc;
unsigned int RsTxLength;
unsigned char* pctxrs;

void CopyRsTxPacket(void){
    unsigned int i = 0;
    unsigned int j = 0;
    while (TxFifoRs.ctRsTx >= SIZE_BUFFER_TXRS){
     Nop();	//ÖÄ£Í, ÅÓÌÉ Tx FIFO ÂÕÆÅÒ
    }
    while (j < RsTxLength){
        i = TxFifoRs.wiRsTx;		
        TxFifoRs.buffRsTx[i++] = RsTxBuffer[j++];; //ÚÁÐÉÓØ × Tx FIFO ÂÕÆÅÒ ÏÄÎÏÇÏ ÂÁÊÔÁ
        TxFifoRs.wiRsTx = i % SIZE_BUFFER_TXRS;
        TxFifoRs.ctRsTx++;
    }
}

void TransmittRsPacket(void){
    unsigned char delay;
    CopyRsTxPacket();
    U3STAbits.UTXEN = 1;
    //------÷ËÌÀÞÅÎÉÅ ÐÅÒÅÄÁÞÉ ÐÏ ÎÁÐÒÁ×ÌÅÎÉÑÍ RS485------------------------
        if(DirRS485.UART_TX3)
        ENTX485 = 1;
        if(DirRS485.UART_TX2)
        _RP16R = _RPOUT_U3TX;    // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A
        ENTX485_I = 0;  // TXD RS485_I ÐÒÏÇÒÁÍÍÎÏ ÐÏÄËÌÀÞÅÎ Ë ×ÙÈÏÄÕ TXD RS485
//    pctxrs =  &RsTxBuffer[0];//ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
    TxRunRs = 1;		//×ÙÓÔÁ×ÌÑÅÍ ÆÌÁÇ ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ
    for(delay = 0; delay < 60; delay ++);
    _U3TXIE = 1;
}

//----------- ISR ïðåðûâàíèå îò UART3 Rx ------------------
//----------- ISR ÐÒÅÒÙ×ÁÎÉÅ ÏÔ UART3 Rx ------------------
void __attribute__((interrupt, auto_psv)) _U3RXInterrupt (void)
{
    //-------------------29.11.21------------------------------
    unsigned char TEMP_U3RXREG;
    unsigned char delay;
    while((U3STAbits.URXDA == 1)){

        TEMP_U3RXREG = (unsigned char)U3RXREG;
        _U3RXIF = 0;
        DirRS485.RX3_OK = 1;
        ErrorDirRS485.RX3_ERROR = 0;
        CounterErrorRs485 = 10;
        if(DirRS485.RX3_TX2){
            int i;
            while (TxFifoRs.ctRsTx >= SIZE_BUFFER_TXRS){//255
             Nop();	//ÖÄ£Í, ÅÓÌÉ Tx FIFO ÂÕÆÅÒ//æä¸ì, åñëè Tx FIFO áóôåð
            }
            i = TxFifoRs.wiRsTx;		
            TxFifoRs.buffRsTx[i++] = TEMP_U3RXREG; //ÚÁÐÉÓØ × Tx FIFO ÂÕÆÅÒ ÏÄÎÏÇÏ ÂÁÊÔÁ//çàïèñü â Tx FIFO áóôåð îäíîãî áàéòà
            TxFifoRs.wiRsTx = i % SIZE_BUFFER_TXRS;
//            _DI();
            TxFifoRs.ctRsTx++;
            if (!TxRunRs) {		//ÅÓÌÉ ÐÅÒÅÄÁÞÁ ÐÏ UART Tx ÎÅ ×ÅÄ£ÔÓÑ, ÔÏ ..//åñëè ïåðåäà÷à ïî UART Tx íå âåä¸òñÿ, òî ..
                TxRunRs = 1;    //ÕÓÔÁÎÏ×ËÁ ÆÌÁÇÁ - ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ //óñòàíîâêà ôëàãà - ïðèçíàêà ïåðåäà÷è
        //------Âêëþ÷åíèå ïåðåäà÷è ïî íàïðàâëåíèþ RS485_I------------------------
        //------÷ËÌÀÞÅÎÉÅ ÐÅÒÅÄÁÞÉ ÐÏ ÎÁÐÒÁ×ÌÅÎÉÀ RS485_I------------------------
                _RP16R = _RPOUT_U3TX;    // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A
                U3STAbits.UTXEN = 1;
                ENTX485_I = 0;  // TXD RS485_I ïðîãðàììíî ïîäêëþ÷åí ê âûõîäó TXD RS485
                                // TXD RS485_I ÐÒÏÇÒÁÍÍÎÏ ÐÏÄËÌÀÞÅÎ Ë ×ÙÈÏÄÕ TXD RS485
                for(delay = 0; delay < 60; delay ++);
                _U3TXIE = 1;	//ðàçðåøåíèÿ ïðåðûâàíèÿ îò UART3 Tx
                                //ÒÁÚÒÅÛÅÎÉÑ ÐÒÅÒÙ×ÁÎÉÑ ÏÔ UART3 Tx
            }
        }
        if(DirRS485.RX3_UART){
            RxFifoRs.buffRsRx[RxFifoRs.wiRsRx ++] = TEMP_U3RXREG;   //ÚÁÐÉÓØ × Rx FIFO ÂÁÊÔÁ ÄÁÎÎÙÈ//çàïèñü â Rx FIFO áàéòà äàííûõ
            // îïðåäåëÿåì ìåñòî êóäà áóäåì ïèñàòü ñëåäóþùèå ïðèíÿòûå äàííûå
            // ÏÐÒÅÄÅÌÑÅÍ ÍÅÓÔÏ ËÕÄÁ ÂÕÄÅÍ ÐÉÓÁÔØ ÓÌÅÄÕÀÝÉÅ ÐÒÉÎÑÔÙÅ ÄÁÎÎÙÅ
            RxFifoRs.wiRsRx = RxFifoRs.wiRsRx % SIZE_BUFFER_RXRS;    /*  ÅÓÌÉ ÂÕÆÅÒ ÚÁÐÏÌÎÉÌÓÑ ÉÌÉ ÐÕÓÔ 
                                                                    * RxFifoRs.wi ÓÔÁÎÅÔ ÒÁ×ÎÙÍ 0
                                                                    * åñëè áóôåð çàïîëíèëñÿ èëè ïóñò 
                                                                    * RxFifoRs.wi ñòàíåò ðàâíûì 0 */
            RxFifoRs.buffRsRx[RxFifoRs.wiRsRx] = 0;
            RxFifoRs.ctRsRx ++; // óâåëè÷èâàåì íà 1 êîëè÷åñòâî íå ïðî÷èòàííûõ áàéò
                                // Õ×ÅÌÉÞÉ×ÁÅÍ ÎÁ 1 ËÏÌÉÞÅÓÔ×Ï ÎÅ ÐÒÏÞÉÔÁÎÎÙÈ ÂÁÊÔ
        }
    }
}
//-------------------29.11.21------------------------------
UINT8 CounterErrorRs485_I;
//----------- ISR ïðåðûâàíèå îò UART2 Rx ------------------
//----------- ISR ÐÒÅÒÙ×ÁÎÉÅ ÏÔ UART2 Rx ------------------
void __attribute__((interrupt, auto_psv)) _U2RXInterrupt (void)
{
    unsigned char TEMP_U2RXREG;
    unsigned char delay;
    while(U2STAbits.URXDA == 1){
        TEMP_U2RXREG = (unsigned char)U2RXREG;
        _U2RXIF = 0;
        DirRS485.RX2_OK = 1;
        ErrorDirRS485.RX2_ERROR = 0;
        CounterErrorRs485_I = 10;
        if(DirRS485.RX2_TX3){
            int i;
            while (TxFifoRs.ctRsTx >= SIZE_BUFFER_TXRS){
             Nop();	//ÖÄ£Í, ÅÓÌÉ Tx FIFO ÂÕÆÅÒ//æä¸ì, åñëè Tx FIFO áóôåð
            }
            i = TxFifoRs.wiRsTx;		
            TxFifoRs.buffRsTx[i++] = TEMP_U2RXREG; //ÚÁÐÉÓØ × Tx FIFO ÂÕÆÅÒ ÏÄÎÏÇÏ ÂÁÊÔÁ//çàïèñü â Tx FIFO áóôåð îäíîãî áàéòà
            TxFifoRs.wiRsTx = i % SIZE_BUFFER_TXRS;
            TxFifoRs.ctRsTx++;
            if (!TxRunRs) {     //ÅÓÌÉ ÐÅÒÅÄÁÞÁ ÐÏ UART Tx ÎÅ ×ÅÄ£ÔÓÑ, ÔÏ ..//åñëè ïåðåäà÷à ïî UART Tx íå âåä¸òñÿ, òî ..
                TxRunRs = 1;    //ÕÓÔÁÎÏ×ËÁ ÆÌÁÇÁ - ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ//óñòàíîâêà ôëàãà - ïðèçíàêà ïåðåäà÷è
        //------Âêëþ÷åíèå ïåðåäà÷è ïî íàïðàâëåíèþ RS485------------------------
        //------÷ËÌÀÞÅÎÉÅ ÐÅÒÅÄÁÞÉ ÐÏ ÎÁÐÒÁ×ÌÅÎÉÀ RS485------------------------        
                U3STAbits.UTXEN = 1;
                ENTX485 = 1;    // TXD RS485 ïðîãðàììíî ïîäêëþ÷åí ê âûõîäó TXD RS485
                                // TXD RS485 ÐÒÏÇÒÁÍÍÎÏ ÐÏÄËÌÀÞÅÎ Ë ×ÙÈÏÄÕ TXD RS485
                for(delay = 0; delay < 60; delay ++);
                _U3TXIE = 1;	//ðàçðåøåíèÿ ïðåðûâàíèÿ îò UART Tx
                                //ÒÁÚÒÅÛÅÎÉÑ ÐÒÅÒÙ×ÁÎÉÑ ÏÔ UART Tx
            }
        }
        if(DirRS485.RX2_UART){
            RxFifoRs.buffRsRx[RxFifoRs.wiRsRx ++] = TEMP_U2RXREG;   //ÚÁÐÉÓØ × Rx FIFO ÂÁÊÔÁ ÄÁÎÎÙÈ//çàïèñü â Rx FIFO áàéòà äàííûõ
            // îïðåäåëÿåì ìåñòî êóäà áóäåì ïèñàòü ñëåäóþùèå ïðèíÿòûå äàííûå
            // ÏÐÒÅÄÅÌÑÅÍ ÍÅÓÔÏ ËÕÄÁ ÂÕÄÅÍ ÐÉÓÁÔØ ÓÌÅÄÕÀÝÉÅ ÐÒÉÎÑÔÙÅ ÄÁÎÎÙÅ
            RxFifoRs.wiRsRx = RxFifoRs.wiRsRx % SIZE_BUFFER_RXRS;   /* ÅÓÌÉ ÂÕÆÅÒ ÚÁÐÏÌÎÉÌÓÑ ÉÌÉ ÐÕÓÔ 
                                                                    * RxFifoRs.wi ÓÔÁÎÅÔ ÒÁ×ÎÙÍ 0
                                                                    * åñëè áóôåð çàïîëíèëñÿ èëè ïóñò 
                                                                    * RxFifoRs.wi ñòàíåò ðàâíûì 0 */
            RxFifoRs.buffRsRx[RxFifoRs.wiRsRx] = 0;
            RxFifoRs.ctRsRx ++; // óâåëè÷èâàåì íà 1 êîëè÷åñòâî íå ïðî÷èòàííûõ áàéò
                                // Õ×ÅÌÉÞÉ×ÁÅÍ ÎÁ 1 ËÏÌÉÞÅÓÔ×Ï ÎÅ ÐÒÏÞÉÔÁÎÎÙÈ ÂÁÊÔ
        }
    }
}
//-------------------29.11.21------------------------------
//----------- ISR ïðåðûâàíèå îò UART3 Tx ------------------
//----------- ISR ÐÒÅÒÙ×ÁÎÉÅ ÏÔ UART3 Tx ------------------
//#include "FunctionTMR.h"
void __attribute__((interrupt, auto_psv)) _U3TXInterrupt (void)
{
    _U3TXIF = 0;		//ÏÞÉÓÔËÁ ÆÌÁÇÁ ÐÒÅÒÙ×ÁÎÉÑ TX
    if (TxFifoRs.ctRsTx) {
        TxFifoRs.ctRsTx --;
		U3TXREG = TxFifoRs.buffRsTx[TxFifoRs.riRsTx ++];		//ÐÅÒÅÄÁ£Í ÏÄÉÎ ÂÁÊÔ
		TxFifoRs.riRsTx = TxFifoRs.riRsTx % SIZE_BUFFER_TXRS;	/* Next read ptr */
    }else{
        _U3TXIE = 0;
        while(!U3STAbits.TRMT); // ÏÖÉÄÁÅÍ ÏÐÕÓÔÏÛÅÎÉÑ ÂÕÆÅÒÁ ÐÅÒÅÄÁÞÉ
        TxRunRs = 0;		//ÓÂÒÁÓÙ×ÁÅÍ ÆÌÁÇ ÐÒÉÚÎÁËÁ ÐÅÒÅÄÁÞÉ
        ENTX485 = 0;
        _RP16R = 0;    // ÉÚÍ ÄÌÑ pcb2.2 ÄÌÑ TD331S485H-A
        ENTX485_I = 1;
        U3STAbits.UTXEN = 0;
    }
}
//-------------------29.11.21------------------------------
//ñáðîñ áóôåðà ïðèåìíèêà è RSR è ñîñòîÿíèÿ îøèáêè ïåðåïîëíåíèÿ áóôåðà
//ÓÂÒÏÓ ÂÕÆÅÒÁ ÐÒÉÅÍÎÉËÁ É RSR É ÓÏÓÔÏÑÎÉÑ ÏÛÉÂËÉ ÐÅÒÅÐÏÌÎÅÎÉÑ ÂÕÆÅÒÁ
void __attribute__ ( ( interrupt, no_auto_psv ) ) _U3ErrInterrupt ( void )
{
    if ((U3STAbits.OERR == 1))
    {
        U3STAbits.OERR = 0;
    }
    IFS5bits.U3ERIF = 0;
}
void __attribute__ ( ( interrupt, no_auto_psv ) ) _U2ErrInterrupt ( void )
{
    if ((U2STAbits.OERR == 1))
    {
        U2STAbits.OERR = 0;
    }
    IFS4bits.U2ERIF = 0;
}
//OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO
//OOOOOOOOOO---æÕÎËÃÉÉ ÕÐÒÁ×ÌÅÎÉÑ éëú---OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO
void Init_IKZ (void)//ðÒÏ×ÅÒËÁ ÃÅÌÏÓÔÎÏÓÔÉ ÌÉÎÉÊ RS485 É ÎÁÞÁÌØÎÁÑ ÕÓÔÁÎÏ×ËÁ ÎÁÐÒÁ×ÌÅÎÉÊ.
{
//    óÂÒÏÓ ×ÓÅÈ éëú
    Reset_IKZ ();
//    ðÒÏ×ÅÒËÁ ÃÅÌÏÓÔÎÏÓÔÉ "ËÏÌØÃÁ"
    TestChenel_IKZ ();
//    õÓÔÁÎÏ×ËÁ ÎÁÐÒÁ×ÌÅÎÉÊ íáóôåòá
    SetChenel_IKZ_M ();
//    óÏÈÒÁÎÅÎÉÅ ÔÅËÕÝÅÇÏ ÓÏÓÔÏÑÎÉÑ ×ÓÅÈ éëú
    SaveChenel_IKZ ();
}

void Terminal_IKZ (void)//ëÏÎÔÒÏÌØ ÃÅÌÏÓÔÎÏÓÔÉ ÌÉÎÉÊ RS485 × ÒÁÂÏÞÅÍ ÒÅÖÉÍÅ.
{
    
}

void Reset_IKZ (void)//óÂÒÏÓ ×ÓÅÈ éëú × ÎÁÞÁÌØÎÏÅ ÓÏÓÔÏÑÎÉÅ.
{
//    óÂÒÏÓ ÎÁÐÒÁ×ÌÅÎÉÊ íáóôåòá
    
//    ëÏÍÁÎÄÁ ÓÂÒÏÓ ÓÏÓÔÏÑÎÉÑ ×ÓÅÈ éëú
    //============ ôåóô ========22.01.20===================================
//    while(ENTX485 || !ENTX485_I); // ÏÖÉÄÁÅÍ ÏËÏÎÞÁÎÉÑ ÐÒÅÄÙÄÕÝÅÊ ÐÅÒÅÄÁÞÉ
//    xprintf("? %lu %u ",StatusBU[2].SerialNumber,222);
//    xprintf("%u\r",crc_value);
//    while(ENTX485 || !ENTX485_I); // ÏÖÉÄÁÅÍ ÏËÏÎÞÁÎÉÑ ÐÒÅÄÙÄÕÝÅÊ ÐÅÒÅÄÁÞÉ
    //============ ëÏÎÅÃ ôåóôÁ ========22.01.20===================================
}

void SaveChenel_IKZ (void)//óÏÈÒÁÎÅÎÉÅ ÔÅËÕÝÅÇÏ ÓÏÓÔÏÑÎÉÑ ×ÓÅÈ éëú É ÏÔËÌÀÞÅÎÉÅ ÎÅÉÓÐÒÁ×ÎÙÈ ÕÞÁÓÔËÏ× RS485.
{
//    ëÏÍÁÎÄÁ ÓÏÈÒÁÎÅÎÉÅ ÔÅËÕÝÅÇÏ ÓÏÓÔÏÑÎÉÑ ×ÓÅÈ éëú
    
}

void TestChenel_IKZ (void)
{
    
}

void SetChenel_IKZ_M (void)
{
    
}
